{\rtf1\ansi\ansicpg1252\cocoartf1187\cocoasubrtf380
{\fonttbl\f0\fswiss\fcharset0 Helvetica;\f1\fnil\fcharset0 Monaco;}
{\colortbl;\red255\green255\blue255;}
{\*\listtable{\list\listtemplateid1\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid1\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid1}
{\list\listtemplateid2\listhybrid{\listlevel\levelnfc23\levelnfcn23\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{disc\}}{\leveltext\leveltemplateid101\'01\uc0\u8226 ;}{\levelnumbers;}\fi-360\li720\lin720 }{\listname ;}\listid2}
{\list\listtemplateid3\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}.}{\leveltext\leveltemplateid201\'02\'00.;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listname ;}\listid3}
{\list\listtemplateid4\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}.}{\leveltext\leveltemplateid301\'02\'00.;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listname ;}\listid4}
{\list\listtemplateid5\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}.}{\leveltext\leveltemplateid401\'02\'00.;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listname ;}\listid5}
{\list\listtemplateid6\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}.}{\leveltext\leveltemplateid501\'02\'00.;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listname ;}\listid6}
{\list\listtemplateid7\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}.}{\leveltext\leveltemplateid601\'02\'00.;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listname ;}\listid7}
{\list\listtemplateid8\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}.}{\leveltext\leveltemplateid701\'02\'00.;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listname ;}\listid8}
{\list\listtemplateid9\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}.}{\leveltext\leveltemplateid801\'02\'00.;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listname ;}\listid9}
{\list\listtemplateid10\listhybrid{\listlevel\levelnfc0\levelnfcn0\leveljc0\leveljcn0\levelfollow0\levelstartat1\levelspace360\levelindent0{\*\levelmarker \{decimal\}.}{\leveltext\leveltemplateid901\'02\'00.;}{\levelnumbers\'01;}\fi-360\li720\lin720 }{\listname ;}\listid10}}
{\*\listoverridetable{\listoverride\listid1\listoverridecount0\ls1}{\listoverride\listid2\listoverridecount0\ls2}{\listoverride\listid3\listoverridecount0\ls3}{\listoverride\listid4\listoverridecount0\ls4}{\listoverride\listid5\listoverridecount0\ls5}{\listoverride\listid6\listoverridecount0\ls6}{\listoverride\listid7\listoverridecount0\ls7}{\listoverride\listid8\listoverridecount0\ls8}{\listoverride\listid9\listoverridecount0\ls9}{\listoverride\listid10\listoverridecount0\ls10}}
\margl1440\margr1440\vieww28600\viewh15200\viewkind0
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural\qc

\f0\b\fs24 \cf0 \
Dual boot OS X Mountain Lion and Debian GNU/kFreeBSD Wheezy on Mac mini
\b0 \
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural
\cf0 \
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural

\b \cf0 Assumptions
\b0 \
\
Starting with a single usable OS X partition called "Macintosh HD", and the hidden recovery partition.\
\
\

\b Goal
\b0 \
\
\pard\tx220\tx454\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\li720\fi-720\pardirnatural
\ls1\ilvl0\cf0 {\listtext	\'95	}Keep both of those partitions at the beginning of the disk.\
{\listtext	\'95	}Add an additional partition called "Storage" for OS X.\
{\listtext	\'95	}Be able to pick Debian GNU/kFreeBSD in the Mac boot manager and in the OS X Startup Disk preference pane.\
{\listtext	\'95	}Have a single ZFS pool with nested datasets using appropriate ZFS properties for Debian GNU/kFreeBSD.\
{\listtext	\'95	}Have a swap partition for Debian GNU/kFreeBSD.\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural
\cf0 \
\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural

\b \cf0 Requirements
\b0 \
\
\pard\tx220\tx454\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\li720\fi-720\pardirnatural
\ls2\ilvl0\cf0 {\listtext	\'95	}Mac mini Mid 2011 (Macmini5,2).\
{\listtext	\'95	}Access to internet using an ethernet cable plugged in the back of the Mac mini.\
{\listtext	\'95	}One empty USB flash drive for temporary usage.\
{\listtext	\'95	}A second empty USB flash drive for permanent usage.\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural
\cf0 \
\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural

\b \cf0 Prepare OS X for cohabitation with Debian GNU/kFreeBSD
\b0 \
\
We need to make room for Debian at the end of the main disk. Interestingly, when shrinking the "Macintosh HD" volume using Disk Utility, it will automatically move the "Recovery HD" partition at the end of the "Macintosh HD" partition, but when it does so it also ends up assigning a new device identifier to the "Recovery HD" partition: it is normally /dev/disk0s3, but after shrinking the "Macintosh HD" volume, "Recovery HD" will appear at /dev/disk0s4. But if you shrink "Macintosh HD" a little more as a second step, it will reassign "Recovery HD" back to its original device identifier, /dev/disk0s3. That's why we will shrink "Macintosh HD" in two steps.\
\
\pard\tx220\tx650\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\li720\fi-720\pardirnatural
\ls3\ilvl0\cf0 {\listtext	1.	}Open Disk Utility.\
{\listtext	2.	}Select the main hard disk entry in the sidebar; this is the entry that is likely to mention the disk manufacturer and the disk size.\
{\listtext	3.	}Go to the "Partition" tab.\
{\listtext	4.	}Click on "Macintosh HD" in the partition layout if it's not selected already.\
{\listtext	5.	}Edit its size to 60 GB in the text field on the right.\
{\listtext	6.	}Click apply.\
{\listtext	7.	}Edit its size again to 50 GB.\
{\listtext	8.	}Click apply.\
{\listtext	9.	}Click the "+" button below the partition layout.\
{\listtext	10.	}Click on the new volume that just appeared in the partition layout. It's likely to be called "Macintosh HD".\
{\listtext	11.	}Edit its name in the text field on the right; I'll use "Storage".\
{\listtext	12.	}Click apply.\
{\listtext	13.	}Click on the newly created volume in the partition layout.\
{\listtext	14.	}Edit its size to 50 GB.\
{\listtext	15.	}Click apply.\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural
\cf0 \
\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural

\b \cf0 Prepare Debian GNU/kFreeBSD Install Media
\b0 \
\
\pard\tx220\tx650\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\li720\fi-720\pardirnatural
\ls4\ilvl0\cf0 {\listtext	1.	}Plug your temporary USB flash drive.\
{\listtext	2.	}Open Terminal.\
{\listtext	3.	}
\f1\fs22 curl --output debian-testing-kfreebsd-amd64-netboot-9-mini.iso http://ftp.us.debian.org/debian/dists/testing/main/installer-kfreebsd-amd64/current/images/netboot-9/mini.iso
\f0\fs24 \
{\listtext	4.	}Find the disk identifier for your USB flash drive by looking at the output of: 
\f1\fs22 diskutil list
\f0\fs24 . If you have no other external storage device plugged, this is likely to be /dev/disk1. Make sure to use that for the next two command line instructions.\
{\listtext	5.	}
\f1\fs22 diskutil unmountDisk /dev/disk1
\f0\fs24 \
{\listtext	6.	}
\f1\fs22 sudo dd if=debian-testing-kfreebsd-amd64-netboot-9-mini.iso of=/dev/disk1 bs=4m\
\ls4\ilvl0
\f0\fs24 {\listtext	7.	}When that command completes, if you see an alert saying "The disk you inserted was not readable by this computer.", just dismiss it by clicking the "Ignore" button.\
{\listtext	8.	}
\f1\fs22 rm -f debian-testing-kfreebsd-amd64-netboot-9-mini.iso
\f0\fs24 \
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural
\cf0 \
\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural

\b \cf0 Boot into Debian GNU/kFreeBSD installer
\b0 \
\
\pard\tx220\tx650\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\li720\fi-720\pardirnatural
\ls5\ilvl0\cf0 {\listtext	1.	}Shut down the Mac mini.\
{\listtext	2.	}Make sure the temporary USB drive with the Debian image is plugged.\
{\listtext	3.	}Also plug the second USB drive for permanent usage.\
{\listtext	4.	}Turn the Mac mini on while pressing the option key until you see the Mac boot manager. You should see two internal volumes, "Macintosh HD" and "Recovery-10.8", and an external USB volume called "Windows".\
{\listtext	5.	}Select the USB volume called "Windows".\
{\listtext	6.	}A few seconds later, you should see a GRUB menu. Select "Expert install (using kernel of FreeBSD 9)".\
{\listtext	7.	}Wait for the installer to finish booting.\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural
\cf0 \
\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural

\b \cf0 Advance in the Debian GNU/kFreeBSD installer until all installer components are downloaded
\b0 \
\
\pard\tx220\tx650\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\li720\fi-720\pardirnatural
\ls6\ilvl0\cf0 {\listtext	1.	}The active selection in the installer menu should be "Choose language". Press enter and select "English".\
{\listtext	2.	}Select "United States" for the country.\
{\listtext	3.	}Select "United States - en_US.UTF-8" for the locale.\
{\listtext	4.	}In the "Configure locales" screen, select "<Continue>" without selecting any additional locale.\
{\listtext	5.	}You should be back in the installer menu with "Configure the keyboard" as the active selection. Press enter and select "American English".\
{\listtext	6.	}You should be back in the installer menu with "Detect network hardware" as the active selection. Press enter.\
{\listtext	7.	}You should be back in the installer menu with "Configure the network" as the active selection. Press enter.\
{\listtext	8.	}If the installer asks you to specify the "Waiting time (in seconds) for link detection", just keep the default value and select "<Continue>". Do this as many times as necessary.\
{\listtext	9.	}After a few seconds, you should land in a screen called "Configure the network" where you need to select the primary network interface. The installer has likely already selected the interface that is plugged. In my case, when I plug my Thunderbolt display, the Mac mini ethernet port corresponds to "bge1".\
{\listtext	10.	}When asked whether to "Auto-configure network with DHCP", say yes, or do whatever manual setup is necessary.\
{\listtext	11.	}After a few seconds, you should land on a screen asking for the hostname. Feel free to change it to whatever you like and continue.\
{\listtext	12.	}Enter the domain name in the next screen and continue.\
{\listtext	13.	}You should be back in the installer menu with "Choose a mirror of the Debian archive" as the active selection. Press enter.\
{\listtext	14.	}Select http as the protocol for file downloads.\
{\listtext	15.	}Select "United States" for the Debian archive mirror country.\
{\listtext	16.	}Select "mirror.cc.columbia.edu" for the Debian archive mirror.\
{\listtext	17.	}Enter any HTTP proxy information if appropriate.\
{\listtext	18.	}After a few seconds, you should be asked for the Debian version to install. Select wheezy - testing and press enter.\
{\listtext	19.	}You should be back in the installer menu with "Download installer components" as the active selection. Press enter.\
{\listtext	20.	}In the list of optional installer components to load, select "parted-udeb" and press enter.\
{\listtext	21.	}Wait for all installer components to download.\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural
\cf0 \
\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural

\b \cf0 Create additional partitions for Debian GNU/kFreeBSD
\b0 \
\
\pard\tx220\tx650\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\li720\fi-720\pardirnatural
\ls7\ilvl0\cf0 {\listtext	1.	}You should be back in the installer menu, which has grown quite a lot since the last time we saw it. Select "Execute a shell" at the bottom of the menu and press enter.\
{\listtext	2.	}Select continue after reading the disclaimer on the interactive shell.\
{\listtext	3.	}You should now be in a minimalist shell.\
{\listtext	4.	}
\f1\fs22 parted /dev/ada0
\f0\fs24 \
{\listtext	5.	}You're likely to see the following warning: "Could not get identity of device /dev/ada0 - Inappropriate ioctl for device"; you are then asked "Ignore/Cancel?". Type "i" and press enter.\
{\listtext	6.	}
\f1\fs22 unit MB
\f0\fs24 \
{\listtext	7.	}
\f1\fs22 print
\f0\fs24 \
{\listtext	8.	}Look at the end value of the last partition (which should be of type HFS+ and called "Storage". In my system, it was 100860MB.\
{\listtext	9.	}Create a 128MB partition called "FreeBSD" of type HFS+. We'll use this for the Mac boot manager and for the OS X Startup Disk preference pane.\
{\listtext	10.	}
\f1\fs22 mkpart hfs+ 100860MB 100988MB
\f0\fs24 \
{\listtext	11.	}
\f1\fs22 name 5 FreeBSD\
\ls7\ilvl0
\f0\fs24 {\listtext	12.	}Create a 4 GB partition called "swap" of type "linux-swap(v1)".\
{\listtext	13.	}
\f1\fs22 mkpart linux-swap(v1) 100988MB 105084MB
\f0\fs24 \
{\listtext	14.	}
\f1\fs22 name 6 swap\
\ls7\ilvl0
\f0\fs24 {\listtext	15.	}Create a partition with the remaining available disk space called "system" of type zfs. To do that, you need to find the appropriate value for the end of the zfs partition.\
{\listtext	16.	}
\f1\fs22 print free
\f0\fs24 \
{\listtext	17.	}Look at the end value of the last Free Space entry. In my system, it was 750156MB.\
{\listtext	18.	}
\f1\fs22 mkpart zfs 105084MB 750156MB
\f0\fs24 \
{\listtext	19.	}
\f1\fs22 name 7 system
\f0\fs24 \
{\listtext	20.	}
\f1\fs22 quit\
\ls7\ilvl0
\f0\fs24 {\listtext	21.	}Turn swap on with the newly created swap partition.\
{\listtext	22.	}
\f1\fs22 mkswap /dev/gpt/swap
\f0\fs24 \
{\listtext	23.	}
\f1\fs22 swapon /dev/gpt/swap
\f0\fs24 \
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural
\cf0 \
\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural

\b \cf0 Create ZFS pool for Debian GNU/kFreeBSD
\b0 \
\
\pard\tx220\tx650\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\li720\fi-720\pardirnatural
\ls8\ilvl0\cf0 {\listtext	1.	}
\f1\fs22 mkdir /target\
\ls8\ilvl0
\f0\fs24 {\listtext	2.	}
\f1\fs22 zpool create -o altroot=/target -o cache file=/tmp/zpool.cache system /dev/gpt/system
\f0\fs24 \
{\listtext	3.	}
\f1\fs22 zpool set bootfs=system system
\f0\fs24 \
{\listtext	4.	}
\f1\fs22 zfs create -o compression=gzip system/home
\f0\fs24 \
{\listtext	5.	}
\f1\fs22 zfs create -o compression=lzjb system/usr
\f0\fs24 \
{\listtext	6.	}
\f1\fs22 zfs create -o compression=lzjb system/var
\f0\fs24 \
{\listtext	7.	}
\f1\fs22 zfs create -o compression=gzip system/var/log
\f0\fs24 \
{\listtext	8.	}
\f1\fs22 zfs create -o compression=lzjb system/var/mail
\f0\fs24 \
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural
\cf0 \
\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural

\b \cf0 Prepare second USB drive to host GRUB boot loader
\b0 \
\
\pard\tx220\tx650\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\li720\fi-720\pardirnatural
\ls9\ilvl0\cf0 {\listtext	1.	}First, you need to find the device identifier for the second USB drive. It's likely to be /dev/da1. But let's confirm that.\
{\listtext	2.	}
\f1\fs22 parted /dev/da1
\f0\fs24 \
{\listtext	3.	}
\f1\fs22 print
\f0\fs24 \
{\listtext	4.	}Confirm that this is the second USB drive by looking at the model information.\
{\listtext	5.	}
\f1\fs22 rm 1
\f0\fs24 \
{\listtext	6.	}
\f1\fs22 mkpart primary fat32 3MB 8119MB
\f0\fs24 \
{\listtext	7.	}
\f1\fs22 set 1 lba off
\f0\fs24 \
{\listtext	8.	}
\f1\fs22 set 1 boot on
\f0\fs24 \
{\listtext	9.	}
\f1\fs22 quit
\f0\fs24 \
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural
\cf0 \
\
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural

\b \cf0 Install Debian GNU/kFreeBSD using debootstrap
\b0 \
\
\pard\tx220\tx650\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\li720\fi-720\pardirnatural
\ls10\ilvl0\cf0 {\listtext	1.	}
\f1\fs22 debootstrap --arch kfreebsd-amd64 --include=zfsutils wheezy /target http://mirror.cc.columbia.edu/debian
\f0\fs24 \
{\listtext	2.	}
\f1\fs22 mkdir -p /target/boot/zfs\
\ls10\ilvl0
\f0\fs24 {\listtext	3.	}
\f1\fs22 cp -a /tmp/zpool.cache /target/boot/zfs
\f0\fs24 \
{\listtext	4.	}
\f1\fs22 chroot /target /bin/bash\
{\listtext	5.	}rm -f /etc/hostname ; echo "machinename.domainname.tld" > /etc/hostname\
\ls10\ilvl0
\f0\fs24 {\listtext	6.	}
\f1\fs22 dpkg-reconfigure tzdata
\f0\fs24 \
{\listtext	7.	}
\f1\fs22 passwd
\f0\fs24 \
{\listtext	8.	}Fill /etc/fstab. TODO: contents.\
{\listtext	9.	}
\f1\fs22 aptitude update\
\ls10\ilvl0
\f0\fs24 {\listtext	10.	}
\f1\fs22 aptitude upgrade\
\ls10\ilvl0
\f0\fs24 {\listtext	11.	}
\f1\fs22 aptitude install kfreebsd-image-9\
\ls10\ilvl0
\f0\fs24 {\listtext	12.	}
\f1\fs22 aptitude install grub-pc\
\ls10\ilvl0
\f0\fs24 {\listtext	13.	}
\f1\fs22 grub-install --modules=part_gpt /dev/da1\
\ls10\ilvl0
\f0\fs24 {\listtext	14.	}
\f1\fs22 update-grub\
\ls10\ilvl0
\f0\fs24 {\listtext	15.	}
\f1\fs22 reboot -f
\f0\fs24 \
}