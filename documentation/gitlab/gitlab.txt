# Installing GitLab 5.0.0.beta1 on Debian GNU/kFreeBSD Wheezy
#
# Created by Joel Lopes Da Silva on 3/18/13.
# Copyright Â© 2013 Joel Lopes Da Silva. All rights reserved.

# Based on ...
# https://github.com/gitlabhq/gitlab-public-wiki/wiki/Debian-Squeeze-complete-Installation-'script'-with-RVM
# https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/installation.md
# https://github.com/gitlabhq/gitlabhq/blob/master/doc/install/databases.md
# https://github.com/gitlabhq/gitlab-recipes/blob/master/apache/gitlab
#
# ... using the following changes ...

# redis-server isn't available for Wheezy kfreebsd-amd64; but it is for sid.
# So temporarily add to /etc/apt/sources.list:
# deb http://mirror.cc.columbia.edu/debian/ wheezy main contrib non-free
aptitude update
aptitude install redis-server
# and remove that line from /etc/apt/sources.list
aptitude update

# System provided ruby seems much more stable and robust than custom ruby builds.
aptitude install ruby ruby-dev
gem install bundler
gem install charlock_holmes --version '0.6.9'

# Instead of adduser --disabled-login --gecos 'GitLab' git
add_system_group git 120
adduser --home /var/lib/git --uid 120 --ingroup git --disabled-password --disabled-login git
chsh git
chfn git

# python2; as git:
mkdir ~git/bin
cd ~git/bin
ln -s /usr/bin/python2.7 python2

# Install .zshenv, .zshrc, .bashrc

# Installing libv8 tends to fail on Debian GNU/kFreeBSD AMD64.
git clone https://github.com/cowboyd/libv8.git
cd libv8
git checkout -b 3.11-kfreebsd origin/3.11
patch -p1 -i /debian-configuration-files/documentation/gitlab/libv8-build-fix-Debian-GNU-kFreeBSD.diff
git commit -a -m "Fix build for Debian GNU/kFreeBSD."
gem build libv8.gemspec
# Move libv8-3.11.8.17.gem to ~git/gitlab/vendor/bundle/ruby/1.9.1/cache/

# We want postgresql, so, as git, in ~git/gitlab:
cp config/database.yml.postgresql config/database.yml
[...]
bundle install --deployment --without development test mysql

# Patch init script, from /etc/init.d
patch -p1 -i /debian-configuration-files/documentation/gitlab/gitlab-5.1.0_init_script_load_bashrc_and_fix_home_directory_location.diff

# Instead of update-rc.d
insserv --verbose gitlab

